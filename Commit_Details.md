# Commit Details

It seems the Check-ins to the repo have way too many minor, major, and cosmetic
changes, so the limited comment line really does not cover what has changed.
Starting with Commit 76 on 11/22/2020 , I will try and do better, and keep track of what is going on in this file.


## Commit \#76 11/22/2020

Changes:
-   Locked which version of **SdFat** and **FastLed** libraries are used in platformio.ini lib_deps section
-   Moved the Boot Log output to the Poll Loop, improvements to how it is displayed
-   Improved handling of SD Card if it is not installed
-   Fix to HPIBOutput()
-   SDREN re-write
-   Minimal Verbose reporting added to all Keywords. More to come.
-   Improvements to the built-in Logic Analyzer output formatting
-   Resolve_Path() now trims leading and trailing spaces from the new path
-   Many minor documentation improvements in about 12 files
-   TXD diagnostic signal is now pulsed by the built-in Logic Analyzer to trigger
    an external Logic Analyzer. This allows comparison of the two Logic Analyzers,
    and the built-in Logic Analyzer now has time stamps on all sample to
    facilitate this capability. This needs to be made conditional so that TXD can be used for other diagnostic purposes
-   A deliberate glitch in the RXD diagnostic signal used to separate Phi 1
    from Phi 2 interrupt processing has been removed, as it contributed a
    minor additional delay to the RC signal.
-   Moved the built-in Logic Analyzer code in Phi 2 processing to after RC
    is asserted, thus reducing the delay to the start of RC. There is more
    work to be done on this front.
-   Started adding support for HP86/86 type ROMs, and the special ROM headers
    for the Secondary AUXROMs.
-   Minor bug fixed in the built-in Logic Analyzer if Ctrl-C was used to end
    the prior acquisition. Affected re-issuing `la go` without doing a new `la setup`
-   With the recent acquisition of a better external Logic analyzer, documented
    the new probing arrangement: `Logic Analyzer Configuration 6 for TLA5201`

### What's going on

There has been an ongoing search for what is causing random failures of the
status reported by the SDREN (rename a file on the SD Card, including changing
the path). The command always does as intended (assuming correct parameters)
but can report either that the command failed, or even a general SD error.
It appears that the issue is the timing of the RC signal has a late start.
The current working theory is that something in the SdFat library, or the
SDIO library that it depends on is delaying the start of RC being asserted,
possibly due to DMA activity on the Teensy 4.1  . Yet other commands that do
reads and writes to the SD card do not show the problem to the same extent.
This commit rearranged some of the code in the Phi 2 processing (where RC
is controlled) seems to have mitigated the issue but further work is required
to achieve a better level of confidence.

Oscilloscope captures still indicate the RC signal generated by EBTKS still
violates timing spec Tif2 (380 ns max) from the 1MB5 spec, by 100 ns.

Fixing this will involve the most of the timing critical code in
`   EBTKS_Bus_Interface_ISR.cpp`

One of the attempted workarounds was to put the HP85 into DMA hold while
this statement executed:
`   rename_status = SD.rename(Resolved_Old_Path, Resolved_Path);`

Yet even this failed, casting doubt on the above theory of the root cause
of the problem.

Another experiment involved moving the storage for all the ROMs from DMAMEM
to FASTRUN memory. It only had a minor effect on the issue. This should be
tried again after other experiments have been tried and implemented.

## Commit \#78 11/23/2020

Changes:
-   Modify MOUNT for tape and disk when the media needs to be created. Now uses
    a shared copy function that is also used for SDCOPY.
-   Implemented SDCOPY

## Commit \#79 11/25/2020

Changes:
-   Updated the possible error messages and AUXERRN numbers reported in
    [Keyword Documentation](http://www.fliptronics.com/HP-85_Adventures/AUXROM_Keywords.html)
-   Update the documentation for AUXCMD, AUXOPT$, AUXBUF$ in
    [Keyword Documentation](http://www.fliptronics.com/HP-85_Adventures/AUXROM_Keywords.html)
-   Change all references to AUXROM_SDMEDIA() to AUXROM_MEDIA()
-   Update some documentation at the top of EBTKS_AUXROM.cpp for AUXCMD, AUXBUF$, AUXOPT$
-   Implement SPRINTF drawing extensively from Everett's emulator code.
    Only the most minimal tests. Crashes HP85 when format string is bad, like "%D"
    about 300 lines of untested code.
-   Disabled USB Host related class instances at top of EBTKS.cpp

## Commit \#80 11/26/2020

Changes:
-   SPRINTF, structure and functionality from Everett, but rewritten in the style
    of the surrounding code, and with many variable names changed, and different
    buffer structure. Also a few bugs found.

## Commit \#81 11/26/2020

Changes:
-   SDCOPY now has an optional Overwrite flag. If no flag is provided, or it is 0
    then Overwrite is an error. If it is 1, the overwrite is allowed.
    Update related website documentation
-   SDSLASH$ Updated related website documentation
-   In EBTKS_SD.cpp, improve documentation about how ROM headers are processed during
    boot, given new support for HP86/87. Also some mostly cosmetic changes to
    other documentation, and some error messages
-   Trivial formatting bug in EBTKS.cpp

## Commit \#82 12/02/2020

Changes:
-   Added SDEOF(file\#) keyword
-   Added SDEXISTS(filePathAndName$) keyword
-   Updated Documentation for SDCAT, SDFFIRST and SDFNEXT. Update the associated custom error messages
-   Implemented EBTKSREV$
    added EBTKS_FIRMWARE_VERSION in EBTKS.h
-   Some prior commit added SETLED
-   SDCLOSE now sends a message to the serial console for each file closed
-   VERBOSE_KEYWORDS now sends a message to the serial console for each Keyword called
    May also provide additional information
-   Minor changes and more debug serial output for SPRINTF
-   Minor changes to SDREN while debugging Phi 2 to RC timing.

## Commit \#83 12/02/2020

Changes:
-   Added documentation on the Term85 virtual terminal object. By RB
    Light editing by PMF

## Commit \#84 12/03/2020

Changes:
-   Integrate the first pass at EMC support, by RB, into EBTKS_Bus_Interface_ISR.cpp
    also cleaned up some formatting
-   change onReadData() to just use the global addReg rather than passing it as a parameter
    since it is only called from one place, and addReg was the only value that is ever passed to it
-   Removed EBTKS_EXTMEM.cpp, as it was just comments

## Commit \#85 12/12/2020

Changes:
-   First successful attempt at dealing with random bus cycle timing when SD Card
    reads occur using quite Byzantine code (by PMF). Issue was tracked down to a
    small critical region in the SdFat library that was disabling all interrups.
    This then randomly made the EBTKS processing of HP85 bus cycles violate timing.
-   Second successful attempt at dealing with random bus cycle timing when SD Card
    reads occur by changing the operating mode of the SD Card from FIFO_SDIO to
    DMA_SDIO which then leads to the code never going down the path in the SdFat
    library that has the critical section (RB). Unless further issues are
    identified, we will stick with this solution
-   Change from supporting Pin interrupts for Phi 1 Rising and Phi 2 Rising to
    only Phi 1 Rising
-   Rename onPhi_2_Rise() to mid_cycle_processing() since it is no longer anchored
    to to the Phi 2 rising edge
-   Reorganize all the pin change interrupt code, and make function sequence match
    execution sequence
-   Identify and document all ISR operations. Look for it just prior to
    pinChange_isr() in EBTKS_Bus_Interface_ISR.cpp
-   Change some global functions to local static
-   Extensive changes to EBTKS_Bus_Interface_ISR.cpp

    -   Significant new documentation, detailed timing analysis will be in next commit
    -   In mid_cycle_processing() move some code that recognizes DMA and Interrupt acknowledgment
    -   Merge various ENABLE_EMC_SUPPORT code sequences  (was EMC_SUPPORT)

-   Delete some of Philip's code that has been commented out for months
-   Mark places in the code that we need to return to with #### tags
-   Print some dots on the diagnostic terminal when waiting for HP85 to boot after the EBTKS boot
-   Change /roms to /roms85 on the SD Card, in preparation to support HP86/87
-   Removed a 2 second delay in the EBTKS boot process

## Commit \#86 12/12/2020

Changes:
-   Correct the date in commit 85 note, above.
-   Fix the Firmware version message in EBTKS.h

## Commit \#87 12/13/2020

Changes:
-   Add new feature to UNMOUNT. Now recognizes "SDCard"              --- not case-sensitive
-   Add new feature to MOUNT.   Now recognizes "SDCard", "anything"  --- not case-sensitive

## Commit \#88 12/16/2020

Changes:
-   Add diagnostic messages to MOUNT for mode 1, Create if LIF does not exits
-   Figured out why SD Card read access while copying Ref LIF image for create
    new virtual disk in MOUNT was randomly failing. When we changed from FIFO_SDIO
    mode to DMA_SDIO, the memory used for the temporary buffer for the copy
    operation became a problem, as it was in EXTMEM. Once it was changed to
    DMAMEM, the problems stopped.
-   Added a documentation section titled "Main Uses of DMAMEM" to EBTKS.cpp
-   In EBTKS_Bus_Interface_ISR.cpp , added note above pinChange_isr() reminding
    that the function prototype must include

    -   __attribute__ ((interrupt ("IRQ")))

-   Now that MOUNT LIF create works, benchmark different read block sizes
-   General improvements to copy_sd_file() that catches errors better, and
    reports them. Part of MOUNT improvement.
-   General improvements to MOUNT error reporting and diagnostic prints.
-   Platformio.ini

    -   Changed SdFat library from 2.0.0-beta.8 to 2.0.2-beta.3
    -   Added "-Wl,--print-memory-usage" which better reports memory usage at
    -   and of compile/Link

## Commit \#89 12/20/2020

Changes:
-   Exhaustive characterization of the timing delays within the very many
    parts of the Pin Change Interrupt
-   Added dump_devices_array() in EBTKS_Utilities.cpp , not currently used
-   There is an unresolved issue with the Serial Monitor command "media"
    with handling the printer association with the file

    -   /printers/printfile.txt

-   There is an unresolved issue with the "printer is 310" assignment (which
    needs ROM 360 printer/plotter to be installed) does not actually seem to
    write to the associated file when PRINT ... command are given. This used
    to work.
-   There is an unresolved issue with the MOUNT/UNMOUNT "SDCard" crashing the
    system.

## Commit \#90 12/28/2020

Changes:
-   More Timing Analysis of the Pin Change Interrupt
-   Report Series 80 Model during boot, improve other boot messages
-   Re-organize the code around the SD.Begin()
-   Changed all the TXD_Pulser() to RXD_Pulser()
-   Minor documentation edit to platformio.ini
-   Updates to HPIB based Printing (to a file on the SD Card)

    -   HpibDisk type becomes HpibDevice type
    -   HpibDevice array now includes device type and Talk/Listen address (tla / \_tla)
    -   New virtual functions close() and getFilename()
    -   New function to check device type isType()

-   Modify HPIBOutput if the character is EOL
-   Diagnostic terminal "media" command now lists printer output file
-   Detailed documentation in EBTKS.cpp describing the issues with FIFO_SDIO mode
    access to the SD Card, and our changing over to DMA_SDIO mode

## Commit \#91 12/29/2020

Changes:
-   Clean up formatting of this file

## Commit \#92 01/08/2021

Changes:
-   Ensure at least 5 us delay between consecutive DMA requests

## Commit \#93 01/26/2021

Changes:
-   Diagnostic code to reveal the actual cache configuration.
    At about line 725 in EBTKS.cpp  , commented out.
-   Integer power function, as used in the above diagnostic code.
-   Flush and delete dcache prior to reading ROM images from SD Card to DMAMEM
-   ROM storage area in DMAMEM now includes alignment to a 32 byte boundary

## Commit \#94 01/31/2021

Changes:
-   Remove DEVELOPMENT_MODE that was only used to control requiring the serial
    terminal to be connected for startup. Now controlled by CONFIG.TXT
-   Store the messages that might go to the HP85 CRT in a buffer, since PWO is
    still asserted when these messages are being created, and the CRT can't be
    accessed if PWO is asserted. Use the first 32 KB of the SDDEL buffer.
-   Store the initial messages that were going to the serial terminal in a the
    second half of the SDDEL buffer, 32 KB. The use the SDDEL 64 KB buffer for
    these two message streams is ok, since SDDEL can't be issued, since the HP85
    has not even started the boot process, and PWO is asserted. 32 KB for each
    of these two streams should be way more than needed. No checks are made for
    going off the end of the buffer.
-   Reporting all the parameter settings at the beginning of CONFIG.TXT to the
    serial output.
-   JSON DOC SIZE is now a parameter at the top of EBTKS_SD.cpp
-   Rename boot_log_ptr to log_to_CRT_ptr which is much clearer, and create a
    separate pointer for the stuff that will go to the serial port: log_to_serial_ptr
-   Add support to both reader and writer of the CONFIG.TXT for the new parameters
-   Resolve the correct combination of ROMs for Floppy emulation, 5 MB hard drive
    emulation, and whether the system is an HP85A or HP85B. Add comments into the
    CONFIG.TXT file as well. These are all AMIGO style drives. The Extended Mass
    Storage ROM (317) is only needed if a real HPIB card is installed and it has
    a SS/80 type disk drive attached.
-   Correct some HPIB select code defaults from 7 to 3.
-   Drive type reported to the serial port now identifies Floppys and 5 MB drives.
-   msus$ are now reported with the mount reporting to the serial port



## Commit \#95 02/03/2021

Changes:
-   Fixed random writing of characters to wrong location on CRT. Issue
    was not waiting for CRT controller to be idle before writing to
    CRTBAD. Bug was in Write_on_CRT_Alpha(). Removed the storied
    comments related to the bug. Was on the right track, but missed
    an instance of the bug. For safety, also checked that all references
    to both CRTBAD and CRTSAD are preceded by a test for not busy.
-   Improved handling of boot message to HP85 CRT and Boot messages that
    are sent to the Serial port (over USB). Both configurable by the
    CONFIG.TXT file. Serial stuff can now be configured to be repeated
    some number of seconds after boot has completed, with a countdown
    timer displayed in the serial stream.
-   Resolved issue with boot failing if we gated everything on the HP85
    reaching the idle loop, EXEC at 000072. The failing code had this
    wait in the setup() function, and it never completed. The reason is
    that part of the AUXROM startup is that it calls some EBTKS functions
    such as WROM so, and all the new keywords are handled in functions in
    the loop() function.
-   Report all the initial settings in CONFIG.TXT to the Serial port.
-   Got rid of all the arbitrary delays in the startup code. Can now get
    from power on to idle loop on HP85 in about 3 seconds, if we aren't
    waiting for the Serial port to become active. This will be the default.
-   Added __DATE__ and __TIME__ to the version info, so now the compiled
    code knows the time and date of compilation. So we no longer have to
    edit a string each time we do a release to correctly identify when
    it was built
-   Found a bug in the RGB LED code. LSB of all 3 bytes for both LEDs
    is always set. Planning to throw away all the C++ code and the FASTLED
    library for some hand crafted replacement. Coming to a code base
    near you, Real Soon Now (tm).
-   Moved and modified all boot message output code (CRT and Serial) from
    other modules to all be at the end of EBTKS.cpp
-   Changed all strcmp() calls to strcasecmp(). Need to look into
    improving the serial port diagnostic monitor, as it no longer needs
    to do case conversion on keyboard commands.
-   Per Russells "Head's up", changed handling of MachineName in SD
    startup code to creating a persistent copy if this parameter,
    rather than using a copy of the ephemeral pointer that would become
    undefined once the loadConfiguration() function finishes.
-   Disabled EMC support as it causes problems with HP85B. Almost certainly
    because of address clashes. this will also affect HP86 and 87. Added
    some new parameters to CONFIG.TXT in preparation for some future code
    that will allow peaceful co-existence. Currently disabled with a
    #define, not yet looking at CONFIG.TXT parameters.
-   Improved reporting of mount/unmount of LIF images to the Serial port,
    with the name of the LIF image. Now also correctly displays the
    virtual printer and tape assignment.
-   FYI:

    -     CygWin wc of include directory:  3456  12788 130393
    -                  src     directory: 11925  59107 491150
    -                  --------------------------------------
    -                  total              15381 lines of code and comments

-   Added some diagnostics to EBTKS_LED.h to try and figure out why
    sending 0,0,0 doesn't turn the LED off. TLA5201 shows that all bytes
    sent have the LSB set regardless of the value (tested with 0 and 170
    which is 0xAA but 0xAB is transmitted) So looks like the bug is
    somewhere in the FASTLED library. Also it needs inverted data. As
    indicated above, I plan to write my own replacement rather than try
    and debug FASTLED.
-   Spell check this file

## Commit \#96 02/03/2021

Changes:
-   Fix display of table in commit 95

## Commit \#97 02/03/2021

Changes:
-   Fix display of table in commit 95

## Commit \#98 02/04/2021

Changes:
-   Change all diagnostics that used TXD and RXD on Teensy Physical pins 9 and 10
    to instead use physical pin 25 (core pin 33) as SCOPE_1 and physical
    pin 31 (core pin 39) as SCOPE_2.
    Change all references RXD to SCOPE_1 and all references to TXD to SCOPE_2
    Doing this because these pins were intended for communications with the ESP32.
    About 100 edits affecting 9 files

## Commit \#99 02/05/2021

Changes:
-   Wrote an EBTKS specific RGB LED driver to replace the FASTLED Library

## Commit \#100 02/09/2021

Changes:
-   Add a 10 second timeout to waiting for the serial terminal, using Systick
    which has been confirmed to be running by the time we get to the Serial.begin().
-   Rewrote utility command Show, deprecated a few others and merged in to Show
-   Removed the code in utility commands to create a lower case version, and instead
    changed all string compares to strcasecmp() and strncasecmp()
-   Added detection of HP85 power off, and forced reset. Now stalls in setup() if
    the HP85 is not powered, but Teensy 4.1 on EBTKS is powered by the USB cable.
    Blinks the orange LED in this condition
-   Detect PWO low in loop(), and force a reset. This was previous code that was
    uncertain if it worked as intended. Now confirmed functional.
-   Removed setjmp()/longjmp() code that was involved in the PWO low detection.
-   Detailed timing analysis of all steps in loop() . 440 ns (or 1200 ns if a Phi 1 ISR occurs)
-   Updated timing analysis in various other parts of the code
-   Removed 280 us delay at end of WS2812B/E RGB LED driver since the HP85 can't send
    requests fast enough for this to be an issue.
-   Added a counter to the Phi 1 ISR. Don't have a use for it yet.
-   Made the loop() counter global. Don't have a use for it yet.

## Commit \#101 02/10/2021

Changes:
-   Correct the year in the above commits 92 to 100
-   Change the HP85 no power code some more, so we aren't doing repeated resets
    which generates repeated USB enumeration, which on a Windows host may lead
    to annoying sound of the disconnect/reconnect alert sound every few seconds.
-   Move the buffers for CRT Log and Serial Log into their own buffers, which
    allows them to be viewed at any time after boot. Uses new Show command.
-   Removed all of the repeatserial and requireserial related code,
    other than the loading the parameter from the CONFIG.TXT file. It
    was really annoying. Now we just check for the Serial channel to
    become valid in loop(), and then dump a copy of both the serial
    log and the CRT message, just once. Check is once per second so
    quite low overhead in loop. Added both to the Show command so you
    can always see it later.

## Commit \#102 02/17/2021

Changes:
-   There were two versions of is_HP85_idle(). The one with lower case
    hp is better and is retained. The HP upper case version is
    commented out for now
-   Started work on a setup process for boot time Logic Analyzer.
    Solved the issue it was intended to be used to debug, before it
    was completed. So far all the setup is in
    Setup_Boot_Time_Logic_Analyzer(), but actually setting it going
    (after serial is connected) and handling the results is un-
    implemented. If this gets future effort, consider pulling
    parameters from a JSON file.
-   Rewrote the Serial terminal "Show" command that now has a variable
    parameter. There are several reserved param values that speed
    things up, and if no match it becomes a file lister. Updated menu
    2 to document this.
-   Fixed bug in Logic Analyzer Setup that was asking for the first
    parameter twice.
-   Fixed bug in error message of copy_sd_file() , since sometimes it
    is opening a Tape file
-   Fixed bug in MOUNT when creating a new Tape image by copying
    blank_T.tap
-   In EBTKS_Tape_Drive.cpp made a change to tapeInCount that seems to
    resolve the issue of Automatically running a program on boot,
    "Autost". The runable must be on a tape and for performance
    reasons, preferably near the beginning. The rest of the extensive
    changes to this file are just formatting, changing from 4 spaces
    per indent to 2, to be compatible with most of the rest of the
    code. Some other files will get the same treatment in the future.

## Commit \#103 02/26/2021

Changes:
-   Remove all references to FastLED library, which is buggy for the simple
    case of a single string of two WS2812B RGB LEDs.

## Commit \#104 02/26/2021

Changes:
-   Finished removal of repeatserial and requireserial in the CONFIG.TXT handling
-   Robustify processing of machineName from the CONFIG.TXT file
-   Serial console commands to show octal and decimal key codes for special keys.
-   Move Config parameters from global data to EBTKS_SD.cpp . Add supporting get_...()
    functions to allow access.
-   Start changing over EMC support by changing parameters from CONFIG.TXT

## Commit \#105 02/26/2021

Changes:
-   RMIDLE processing to support AutoStart commands and Batch processing
    and related CONFIG.TXT processing to support this.
-   Disable (in prep for removal) writing of a default CONFIG.TXT
-   More EMC support in CONFIG.TXT handling in EBTKS_SD.cpp

## Commit \#106 02/26/2021

Changes:
-   Partial update of EMC code to new CONFIG.TXT parameters. Still all
    commented out until all changes have been made. So mostly folding
    in Russell's EMC update that predates the CONFIG.TXT changes

## Commit \#107 03/09/2021

Changes:
-   Modified critical sections of the Serial driver (not part of this code base, but part of a library we depend on).
    Here are the edit notes:

    -   Multiple changes to --- .platformio\packages\framework-arduinoteensy\cores\teensy4\HardwareSerial.cpp
    -
    -   4 occurences    at line (approx)        404, 449, 488, 569 (after edits)
    -   Replace         __disable_irq();
    -   with            NVIC_DISABLE_IRQ(hardware->irq);
    -
    -   6 occurrences   at line (approx)        413, 464, 468, 498, 503, 575 (after edits)
    -   Replace         __enable_irq();
    -   with            NVIC_ENABLE_IRQ(hardware->irq);
    -

-   Start integration of Russell's ESP32 support. CRT is sent to http://esp32_ebtks.local/
-   Add EBTKS_ESP.h to the file set. Thanks RB.
-   Implement SDBATCH, basically hook a file to the RMIDLE processing
-   Add the Arduino Base 64 library to platformio.ini   agdl/Base64

## Commit \#108 03/15/2021

Changes:
-   Moved the HPIB Select Code up one level in CONFIG.TXT and removed the duplicate
    entries in each of the devices. Updated EBTKS_SD.cpp to match
-   Added CONFIG.TXT to the root of the project, so that it will be copied to GitHub.
    This means I need to remember to manually update it in this directory,
    every time it is updated in its real location. Because Windows doesn't have functional links.
-   Heading update for Logic Analyzer

## Commit \#109 03/19/2021

Changes:
-   Remove code duplication for mounting LIF files that occured with MOUNT "SDCard". About 100 lines of code.
-   Remove "type" field from printer specification in CONFIG.txt

## Commit \#110 03/21/2021

Changes:
-   Move initialization of startup logging pointers in prep for earlier boot process info
-   Delay EMC initialization until after the CONFIG.TXT has been processed
-   Move EMC limits calculation to only-once code in during boot
-   Removed redundant message calculations for LOGPRINTF() in the CONFIG.TXT processing
-   Correct all references to EMS memory to EMC memory
-   Bracket all EMC code with conditional compilation controlled by ENABLE_EMC_SUPPORT
-   Remove passing around Master status for EMC code. Now a compile time selection. Except for modified HP85A computers, EBTKS is never the Master.
-   Fix some spellink misstakes
-   Re-indented EBTKS_ESP.h

## Commit \#111 03/21/2021

Changes:
-   First cut at SD Card dates. Use the compile time of the Firmware
-   Some interesting macros for time and date in EBTKS.h

## Commit \#112 03/22/2021

Changes:
-   Deleted commented out deprecated code in EBTKS_SD.cpp
-   Simplified filepath for tape, disk, and printer emulation in the CONFIG.TXT file and the code that processes it.
-   Fixed un-detected bug in remount_drives() of file being opened but not closed

## Commit \#113 03/24/2021

Changes:
-   Simplify printer section of CONFIG.TXT and adjust code in EBTKS_SD.cpp to match
-   Only enable EMC if more than zero banks
-   Minor formatting change to Log File

## Commit \#114 04/08/2021

Changes:
-   Drop Max ROMS from 20 down to 18, since other constraints make 20 more than can be used
-   EMC enabled now conditional on both successful read of config file, and that it is requested
-   Explicitly enumerated the machine_numbers enum. To do: propagate these enums into various
    conditionals, and remove magic numbers.
-   Fixed handling of ROM IDs for HP86 and HP87 when loading the selected ROMs per entries in CONFIG.TXT
-   Inhibit test for ram16k option if machineNum isn't MACH_HP85A
-   Inhibit test for tape drive emulation option if machineNum isn't MACH_HP85A or MACH_HP85B
-   Inhibit checking EMC banks if EMC is not enabled, add some related diagnostic messages
-   New CONFIG.TXT parameter: enableTapeAutostart .  To do: parse it during startup and use
    it to inhibit testing the tape drive at boot time
-   Initial support for RTC with battery backup, using Teensy 4.1 built-in RTC (~ 30uA power consumption)
-   Synchronize the RTC with the Secure RTC (SRTC)
-   Some test routines to test RTC

## Commit \#115 04/12/2021

Changes:
-   Add support for Real Time Clock (RTC) with battery backup

## Commit \#116 04/21/2021

Changes:
-   Correct all references to EMS memory to EMC memory (including this file)
-   EMC Master functionality is only enabled if machine type is HP85AEMC, which is
    for HP85A computers that have the backplane modified for the IF signal, and
    the IF signal is routed from the CPU to the backplane (which can be done over
    the flatflex, with quite difficult rework on both the mainboard and backplane
    board because sinal traces need to be cut, and access requires desoldering
    the 17 pin flatflex connectors at each end)
-   Significant improvement to documentation in the sources about EMC operation
-   Better usage of machineNum matching enums, rather than in-line constants.
-   Apparently EMC for EDisk works on an HP85AEMC even without the IF signal
    modification. Still requires CONFIG.TXT to have

    -   "machineName": "HP85AEMC"

    since it enables the EMC setup code. Don't know if master mode is a requirement

## Commit \#117 05/05/2021

Changes:
-   Add tester for PSRAM, including avoiding allocated PSRAM memory, which requires
    an additional line to be added to

    -  C:\Users\me\\.platformio\packages\framework-arduinoteensy\cores\teensy4\imxrt1062_t41.ld

-   which is not tracked by Git. The change is to add the following at line 89

    -  \_extram_alloc = SIZEOF(.bss.extram) + 0x70000000;

## Commit \#118 05/05/2021

Changes:
-   Add support for "screenEmu" in CONFIG.TXT

    -   screenEmu is needed for the help system, for CRTRemote, and terminal emulation
    -   it is not currently supported for HP86 and HP87
    -   even if screenEmu is false, we still track CRTBAD and CRTSAD, but don't
        maintain an image of the CRT, and don't allow writes to the actual CRT
        memory. This can change once the HP86/87 video system is emulated

## Commit \#119 05/05/2021

Changes:
-   Add support for "CRTRemote" in CONFIG.TXT
-   Throttle how much time it can take in main loop(), because it interfered with
    the logic analyzer


## Commit \#120 05/13/2021

Changes:

-   Add diagnostics to help with debugging EMC support. There are two
    separate, and mutually exclusive diagnostic routines. At most 1
    can be enabled at compile time by setting ENABLE_TRACE_EMC or
    ENABLE_TRACE_PTR2 to 1. The trace buffer for both of these fill up
    until full, then stop. The contents is dumped with the diagnostic
    command EMC. When the dump is finished, the trace buffer is reset.
    The tracing for the second function is conditioned on the value of
    Ptr2 being within a range specified at compile time with
    EMC_PTR2_TRACE_WINDOW_LOW and EMC_PTR2_TRACE_WINDOW_HIGH. It is
    expected that this trace function will be used together with the
    BASIC testprogram that exercises the Ptr2 register. Currently the
    program is named PFTEST2, and the companion binary program is
    named pfemc.bin and must be imported as pfemcbin
-   Added a diagnostic backdoor path for pfemcbin to access the EBTKS
    version of Ptr2, even though EBTKS is not the Master EMC. The I/O
    location assigned is 177760
-   Eventually tracked the EMC functionality bug to an incorrect
    polarity test of the IFETCH signal
-   Pre-calculated EMC start and end addresses so that they are not
    being calculated during the time critical indirect load and stores
    through the pointer registers. Changed the end address to be
    controlled by information from CONFIG.TXT rather than just the
    maximum size.
-   Add ESP32 serial pass-through function for programming the ESP32
    using the Serial-Over-USB link to Teensy.
-   Add linkage to the ESP32 serial pass-through to the diagnostics menu
-   Re-assign Teensy pins T09 and T10 to ESP_EN and ESP_BOOT respectively,
    to support programming of ESP32
-   Add tracking of the 1MB1 Processor (Capricorn) DRP register to the
    Logic Analyzer. Do not expect this to be correct on HP85A, but
    should be correct on all other Series80 computers that we support,
    including HP85AEMC

## Commit \#121 05/15/2021

Changes:

-   Fix range bug in diag console set_time()
-   Implement new keyword DATETIME A,B,C,D

## Commit \#122 05/22/2021

Changes:

-   Start up a little faster by reducing delay to loop() from 5 seconds to 1
-   Have seen rare times LED near SD Card starts up bright green, suggests there
    may be a timing issue, or signal integrity.
-   Removed the diagnostic console command to change the loaded tape image, tload
-   Added a diagnostic console command to show keyboard codes, for things like the
    Arrow keys that return multi-character escape sequences. Note that different
    terminal emulators may return different sequences, and maybe also different
    sequences based on which iconic terminal is being emulated. Note that VSCode's
    built-in terminal uses sequences that are quite different from VT100. EBTKS
    in the diagnostic interface assumes that Tera Term is being used, with VT100
    emulation, with ANSI escape sequences.  https://en.wikipedia.org/wiki/ANSI_escape_code
-   Simple Keyboard history buffer for diagnostic console
-   Update diagnostic console help
-   Change all reference to machineNum to use the enums for various Series80 computers

## Commit \#123 05/26/2021

Changes:

-   Reorganize some startup messages, CRT Log gets note about scrolling up for more
-   CRT Log message now works with HP85B and HP87A
-   Added CRT_Timing_Test_5() to check EBTKS direct writing to HP86/87 CRT memory
-   Ctrl-C escape from PSRAMTest
-   Allow Tape Drive enable to be seen outside SD Card CONFIG.TXT processing so that
    log to diagnostic console can show state.
-   Refactor CRT direct access functions, and make them handle both the 32x16 screen
    of the HP83/85/9915, and the 80x16 scren of HP86/87. Still need to support the
    multiple ALPHA modes on HP86/87. Two new sets of functions:

    -  For situations where only a few register accesses are going to happen, a
       set of "Safe" functions that sort out both the machine type (CRT controller
       type) and checking busy status.
    -  For situations where there will be many register references (such as save/restore screen)
       a set of "Safe" that require that the EBTKS is already in DMA mode.

    These routines select the I/O register locations based on the machine type from CONFIG.TXT
-   Memory for CRT/screen emulation changed from 8 kB to 16 kB.
-   Tag CRT tests that have not yet been modified to support HP86/87

## Commit \#124 05/31/2021

Changes:

-   Updated Logic Analyzer signal assignments to match the V3.0 Production boards

-   Wake up the diagnostic serial over USB port, without waiting for
    checking whether the port is available. This cuts down the number
    of situations where firmware updating requires pressing the button
    on the Teensy 4.1 processor module
-   Change the Teensy powered via USB flash pattern, 3 short flashes every 10 seconds
-   Extensive changes to machineNum and related macros to better support various
    models of the Series80, and make sure that incompatible settings are disabled
    and (some are) reported. Mostly in EBTKS_SD.cpp
-   Refined the list of Series80 computers to include HP83 and HP9915A/B
-   Caught and fixed unseen but potential buffer overrun error in
    mount_drives_based_on_JSON() and remount_drives()
-   Tracked down HP87 crashes to SDWRITE not handling strings over 1 kB length. Issue is
    probably in AUXROMs for HP86/87

## Commit \#125 06/03/2021

Changes:

-   Add CRT save and restore support for HP86/87, including ALPHA and ALPHALL modes
-   Fix mask/limit processing of CRT addresses for HP86/87
-   Add testing of HP86/87 Save and restore to test function "CRT 4"
-   Review RMIDLE processing. Looks like the SDBATCH might not have been finished

## Commit \#126 06/13/2021

Changes:

-   Add new diagnostic command SDCID that reports technical information about the SD Card

## Commit \#127 06/21/2021

Changes:

-   Rewrite SDCAT, SDDEL, Diagnostic directory listings
-   Rewrite diag_dir_path
-   Remove Print_Splitter.h and all references
-   Removed all remaining usage of EXTMEM. Note that previously this memory
    region had issues with DMA. See commit 85
-   Diag Show ROMs now selects based on machine type
-   Changes to PSRAMTest, now puts HP8x into DMA mode for duration of test and
    now there does not seem to be any problems. Assume that access to PSRAM is
    causing interrupt latency issues, but no test setup yet detects this.
-   Integrated and modified Russell's DirLine Class, so that the big listing
    buffers and the associated Print_Splitter.h Class are no longer needed.
    This is part of the rewrite of SDCAT, SDDEL, and Diagnostic directory listings
-   Deleted Print_Splitter.h from project
-   Changed memory for CRT_Log_Buffer and Serial_Log_Buffer from EXTMEM to DTCM
    If we get in a bind, it could be moved to DMAMEM in the future.

## Commit \#128 06/29/2021

Changes:

-   Add reset of ESP32 module during boot
-   If we don't have configuration success (reading CONFIG.TXT), don't do CRT
    emulation initialization, as we don't know what type of CRT controller we have.
-   On diag console, add new commands to dump the visible part of the CRT text
    buffer, or the whole buffer. For both types of CRT controller. No support
    yet for graphics mode. Update Help 1.
-   Update test function sdreadtimer
-   Remove data duplication related to CRT controll register mirror.
-   Finish removing Print Splitter references in Class DirLine
-   Add support for starting a new directory scan (First/Next) even if the prior
    scan did not complete.
-   Add much more verbose tracking of the SDCAT function. A compile time selection
-   Remove misleading/deprecated documentation from SDCAT
-   Don't try unmounting the emulated tape drive on computers that can't have a tape drive (HP86, HP87)

## Commit \#129 07/30/2021

This commit is the first after the production release snapshot on 7/12/2021 . There were no changes between commit 128 and the snapshot.

Changes:

-   This is a documentation update only. The 30 second timeout is part of the 7/12/2021
    firmware on all shipped EBTKS.
    ESP32 programmer pass-through function (console command is: esp32 prog)
    updated with documentation about the need for pyserial.py , and the
    addition of a 30 second timeout that is reset by activity on the USB-to-Serial
    port which is used by the ESP32 programmer software on a PC, as well as the
    service console. After 30 seconds of idle, ESP_Programmer_Setup() exits back to
    the main console command loop. While ESP_Programmer_Setup() is running, the main
    background polling loop is stalled, anything that depends on being polled will
    not get serviced. For example: All AUXROM keywords. A BASIC program that does
    not try and use EBTKS disk/tape emulation, logic analyzer, remote CRT, or AUXROM
    keywords, should continue running.
-   Add Date and time to start of the startup logfile that is written to the SD Card
-   Serial2 link begin() is no longer conditional on HP85 style screen. Remote
    transfer to HP86/87 not yet supported
-   Improved diagnostic tracing around MOUNT and SETLED keyword
-   Added more documentation to top of HPDisk.h . Still need to do documention for emulated
    Winchester disk drives
-   Added documenatation to EBTKS_ESP.h about programming the ESP32 without the IDE


## Commit \#130 09/24/2021

Changes:

-   This commit is mostly about a complete rewrite of the RMIDLE handling, and a fair bit of new
    documentation in related code. Also improvements to escape sequence processing in the RMIDLE
    code for commands from CONFIG.TXT and batch files. None needed for characters over WiFi
-   Add hook for inserting characters into keyboard stream from WiFi (i.e. a remote Browser)
-   Add place holder for capturing HP8x keystrokes and redirecting to an alternative keystroke
    consumer, such as an emulator for some other process (PDP-8/E emu, HP8x emu, terminal emu...)
-   Serial and CRT startup message buffer usage now reported in EBTKSLog.log
-   Autostart from CONFIG.TXT now reported in EBTKSLog.log
-   JSON_DOC_SIZE bumped up from 5500 to 7000 to give some safety room for end users playing with
    the CONFIG.TXT file
-   Fix line wrap and overwrite issue on CRT boot up messages for 16 kB RAM and tape drive emulation

## Commit \#131 01/06/2023

Changes:

-   Note: As of this date all 260+ EBTKSes were shipped with firmware dated 07/12/2021, which
    was built after commit 128
-   This commit will be the base for EBTKS firmware V2.0 . It includes all the changes
    that were under development in V1.0 (mostly minor cleanup, and experimental WiFi
    file transfer), and the starting point for using the integrated SdFAT support in
    the updated TeensyDuino. Jumping from TeensyDuino V1.53 to 1.57
-   Related:  https://forum.pjrc.com/threads/71148-SD-library-issues
-   This commit is a catch-all for multiple small changes that happened over 3 months and
    wern't pushed to github, as some of it was/is experimental. Some of the WiFi related
    changes are likely to be reverted. Look to the next commit as a starting point for any
    non Philip/Russell development work. i.e. things are in flux more than normal.
-   Formatting changes scatterd through this file, correcting MarkDown errors, mostly related
    to indented sub-lists and escaping leading underscores
-   No longer pulling in the Base64 library, as it has an initialization fault. Although the patch
    is easy to implement, the PlatformIO "Clean all" deletes the libraries in \\.pio\\libdeps,
    including the patch. Instead I copied it to the include and src directories, and modified
    platformio.ini so that it would no longer fetch it from the interwebs. Local copies of the
    following file.  **Looks like HardwareSerial.cpp** might also need this attention

    -   Base64.h            **This is now in the include directory**

-   LZS Compression and Decompression havs been added. This is used in
    EBTKS_CRT.cpp as part of the transmission of CRT images over WiFi
    to a remote browser. These files were released with the  MIT license.
    This code may be removed in a future commit, as this functionality is fairly experimental

    -   lzs.h               **This is now in the include directory**
    -   lzs-common.h        **This is now in the include directory**
    -   lzs-compression.c   **This is now in the src directory**
    -   lzs-simple-compression.c   **This is now in the src directory**

-   Initial test of file transfer over WiFi
-   Starting around manufacturing batch 4 or 5, (around October 2021) some strange startup
    issues were observed with the LEDs, not seen in prior manufacturing batches. A workaround
    was added to the CONFIG.TXT files that executed a batch command to initialize the LEDs
    once the HP8X system got to the RMIDLE prompt. This workaround had no effect if the LEDs
    did not have this issue (which appeaed to be somewhat random). The issue is the LEDs
    initialized to very bright green.
-   The LED initialization has been changed to turn LEDs off during setup(), and initialize
    them in loop() which is then over-ridden by startup batch from CONFIG.TXT . This has not
    been extensively tested, since this firmware work around has not shipped with any EBTKS.
-   Initialize LEDs in loop() after 2000ms. This may setup a race condition with the batch
    command workaround described in the prior bullet. May need to inform end users to edit
    CONFIG.TXTs to remove the batch command if this firmware fix works.
-   Fix some spellink errers, and some punctuation
-   Initial hooks to insert characters into the HP8x keyboard buffer from the WiFi link
-   Try and standardize formatting

    -   Allman style braces (the curly ones)
    -   Keywords followed by spaces before brackets (the curved ones)
    -   Empty brace pair on while can be on 1 line:  while (condition) {}   // explain
    -   Spaces around operators:  use "value >> 3"  rather than "value>>3"
    -   In parameter list, no space before a comma, space after comma:  func(param1, param2, param3);

-   The DirLine.h class looks like it was extracted from EBTKS_AUXROM_SD_Services.cpp (around line 400)
    and placed in /include, but there is still a copy in EBTKS_AUXROM_SD_Services.cpp , so this looks
    like an incomplete edit. There is a single reference to it in EBTKS_ESP.h . This class declaration
    should probably be removed from EBTKS_AUXROM_SD_Services.cpp, and appropriate changes made to use
    DirLine.h .
-   In file SdFatConfig.h at line 78:

    -  #define SDFAT_FILE_TYPE 1     // PMF and RB was 3, but caused library problems like can't find isReadOnly()

    This was done ages ago, but not documented in this file.
-   Note:  PlatformIO "Clean All" wipes all of .pio/build and .pio/libdeps. So on the next build,
    the libraries will be retrieved from the interwebs. platformio.ini specifies the folowing libraries
    with specific versions.

    -   ArduinoJson@6.16.1
    -   https://github.com/greiman/SdFat-beta.git#2.0.2-beta.3
    All other libraries will fetch the most current. see the previous item about SDFAT_FILE_TYPE in
    SdFatConfig.h, since this will fetch the internet version which won't have this patch.
    On first build after "Clean All" , expect to see the following excerpts in the build log:

    -   Library Manager: SdFat@2.0.2-beta.3+sha.ee0df78 has been installed!
    -   framework-arduinoteensy @ 1.153.0 (1.53)  (this is not installed, because it is not deleted by
        the Clean All, as it is not part of the repo.
    -   Library Manager: Installing ArduinoJson @ 6.16.1
    It then starts compiling project sources and gets errors in EBTKS_Logging.cpp.o     , and many more.
    Edit SdFatConfig.h and replace line 78 with
    
    -   #define SDFAT_FILE_TYPE 1     // PMF and RB was 3, but caused library problems like can't find isReadOnly()
        
    Now do a normal clean and build, and there should be no errors


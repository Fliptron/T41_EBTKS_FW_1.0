# Commit Details

It seems the Check-ins to the repo have way too many minor, major, and cosmetic
changes, so the limited comment line really does not cover what has changed.
Starting with Commit 76 on 11/22/2020 , I will try and do better, and keep track of what is going on in this file.


## Commit \#76 11/22/2020

Changes:
-   Locked which version of **SdFat** and **FastLed** libraries are used in platformio.ini lib_deps section
-   Moved the Boot Log output to the Poll Loop, improvements to how it is displayed
-   Improved handling of SD Card if it is not installed
-   Fix to HPIBOutput()
-   SDREN re-write
-   Minimal Verbose reporting added to all Keywords. More to come.
-   Improvements to the built-in Logic Analyzer output formatting
-   Resolve_Path() now trims leading and trailing spaces from the new path
-   Many minor documentation improvements in about 12 files
-   TXD diagnostic signal is now pulsed by the built-in Logic Analyzer to trigger
    an external Logic Analyzer. This allows comparison of the two Logic Analyzers,
    and the built-in Logic Analyzer now has time stamps on all sample to
    facilitate this capability. This needs to be made conditional so that TXD can be used for other diagnostic purposes
-   A deliberate glitch in the RXD diagnostic signal used to separate Phi 1
    from Phi 2 interrupt processing has been removed, as it contributed a
    minor additional delay to the RC signal.
-   Moved the built-in Logic Analyzer code in Phi 2 processing to after RC
    is asserted, thus reducing the delay to the start of RC. There is more
    work to be done on this front.
-   Started adding support for HP86/86 type ROMs, and the special ROM headers
    for the Secondary AUXROMs.
-   Minor bug fixed in the built-in Logic Analyzer if Ctrl-C was used to end
    the prior acquisition. Affected re-issuing `la go` without doing a new `la setup`
-   With the recent acquisition of a better external Logic analyzer, documented
    the new probing arrangement: `Logic Analyzer Configuration 6 for TLA5201`

### What's going on

There has been an ongoing search for what is causing random failures of the
status reported by the SDREN (rename a file on the SD Card, including changing
the path). The command always does as intended (assuming correct parameters)
but can report either that the command failed, or even a general SD error.
It appears that the issue is the timing of the RC signal has a late start.
The current working theory is that something in the SdFat library, or the
SDIO library that it depends on is delaying the start of RC being asserted,
possibly due to DMA activity on the Teensy 4.1  . Yet other commands that do
reads and writes to the SD card do not show the problem to the same extent.
This commit rearranged some of the code in the Phi 2 processing (were RC is
controlled) seems to have mitigated the issue but further work is required
to achieve a better level of confidence.

Oscilloscope captures still indicate the RC signal generated by EBTKS still
violates timing spec Tif2 (380 ns max) from the 1MB5 spec, by 100 ns.

Fixing this will involve the most of the timing critical code in
`   EBTKS_Bus_Interface_ISR.cpp`

One of the attempted workarounds was to put the HP85 into DMA hold while
this statement executed:
`   rename_status = SD.rename(Resolved_Old_Path, Resolved_Path);`

yet even this failed, casting doubt on the above theory of the root cause
of the problem.

Another experiment involved moving the storage for all the ROMs from DMAMEM
to FASTRUN memory. It only had a minor effect on the issue. This should be
tried again after other experiments have been tried and implemented.

## Commit \#78 11/23/2020

Changes:
-   Modify MOUNT for tape and disk when the media needs to be created. Now uses
    a shared copy function that is also used for SDCOPY.
-   Implemented SDCOPY

## Commit \#79 11/25/2020

Changes:
-   Updated the possible error messages and AUXERRN numbers reported in
    [Keyword Documentation](http://www.fliptronics.com/HP-85_Adventures/AUXROM_Keywords.html)
-   Update the documentation for AUXCMD, AUXOPT$, AUXBUF$ in
    [Keyword Documentation](http://www.fliptronics.com/HP-85_Adventures/AUXROM_Keywords.html)
-   Change all references to AUXROM_SDMEDIA() to AUXROM_MEDIA()
-   Update some documentation at the top of EBTKS_AUXROM.cpp for AUXCMD, AUXBUF$, AUXOPT$
-   Implement SPRINTF drawing extensively from Everett's emulator code.
    Only the most minimal tests. Crashes HP85 when format string is bad, like "%D"
    about 300 lines of untested code.
-   Disabled USBHost related class instances at top of EBTKS.cpp

## Commit \#80 11/26/2020

Changes:
-   SPRINTF, structure and functionality from Everett, but rewritten in the style
    of the surrounding code, and with many variable names changed, and different
    buffer structure. Also a few bugs found.

## Commit \#81 11/26/2020

Changes:
-   SDCOPY now has an optional Overwrite flag. If no flag is provided, or it is 0
    then Overwrite is an error. If it is 1, the overwrite is allowed.
    Update related website documentation
-   SDSLASH$ Updated related website documentation
-   In EBTKS_SD.cpp, improve documentaion about how ROM headers are processed during
    boot, given new support for HP86/87. Also some mostly cosmetic changes to
    other documentation, and some error messages
-   Trivial formatting bug in EBTKS.cpp

## Commit \#82 12/02/2020

Changes:
-   Added SDEOF(file\#) keyword
-   Added SDEXISTS(filePathAndName$) keyword
-   Updated Documentation for SDCAT, SDFFIRST and SDFNEXT. Update the associated custom error messages
-   Implemented EBTKSREV$
    added EBTKS_FIRMWARE_VERSION in EBTKS.h
-   Some prior commit added SETLED
-   SDCLOSE now sends a message to the serial console for each file closed
-   VERBOSE_KEYWORDS now sends a message to the serial console for each Keyword called
    May also provide additional information
-   Minor changes and more debug serial output for SPRINTF
-   Minor changes to SDREN while debugging Phi 2 to RC timing.

## Commit \#83 12/02/2020

Changes:
-   Added documentation on the Term85 virtual terminal object. By RB
    Light editing by PMF











